# mpnp-ddi
A Multi-Scale Graph Neural Process with Cross-Drug Co-Attention for Drug-Drug Interaction Prediction

This repository contains the official PyTorch implementation for an enhanced framework to predict Drug-Drug Interactions (DDI). The core of this project is the Improved_MPNP_DDI model, which leverages concepts to create multi-scale drug representations. It incorporates co-attention mechanisms and uncertainty estimation to provide robust and interpretable DDI predictions.
Key Features

    Robust Data Preprocessing: A comprehensive script (preprocess.py) that converts SMILES strings into graph structures, generates triplets, and performs robust negative sampling.
    Multi-Scale Graph Embeddings: The model uses a series of GNP_Block modules to learn drug features at different resolutions, capturing both local and global structural information.
    Co-Attention Mechanism: A CoAttentionLayer dynamically weighs the importance of each feature scale by comparing the representations of the two interacting drugs.
    Uncertainty Estimation: The model predicts not only the interaction type but also quantifies its own uncertainty, which is crucial for applications in drug discovery and safety.
    Flexible Training Pipeline: The training script (train.py) supports mixed-precision training, gradient accumulation, early stopping, and detailed logging with automatic performance chart generation.
    Modular Architecture: The code is organized into logical components (dataset, layers, model, training), making it easy to understand, modify, and extend.

Project Structure

MPNP-DDI/
├── data/
│   ├── bio-decagon-combo/
│   │   └── bio-decagon-combo.csv   # Raw Decagon dataset
│   └── drugbank.tab                # Raw DrugBank dataset
│   └── preprocessed/               # Output directory for processed data
│       ├── drugbank/
│       └── decagon/
├── save/
│   └── ...                         # Output directory for models, logs, and charts
├── layers.py                       # Contains custom neural network layers (CoAttention, RESCAL, etc.)
├── model.py                        # Defines the main model architecture (Improved_MPNP_DDI)
├── dataset.py                      # PyTorch Dataset and DataLoader classes
├── preprocess.py                   # Script for data preprocessing and negative sampling
├── train.py                        # Main script to run training and evaluation
├── train_logger.py                 # Utility for structured logging and saving
├── utils.py                        # Helper functions and CustomData class
└── README.md                       # This file

Installation

    Create a Conda environment (Recommended):
    RDKit is best installed via Conda.

    conda create -n ddi_env python=3.9
    conda activate ddi_env
    conda install -c conda-forge rdkit

    Install PyTorch and PyG:
    Follow the official instructions for your specific CUDA version. For example:

    # For CUDA 11.8
    pip install torch torchvision torchaudio
    pip install torch_scatter torch_sparse torch_cluster torch_spline_conv -f https://data.pyg.org/whl/torch-2.1.0+cu118.html
    pip install torch_geometric

    Install other dependencies:

    pip install pandas numpy scikit-learn tqdm matplotlib

Data Preparation

The preprocess.py script handles the conversion of raw data into a format suitable for the model. It generates graph objects, positive interaction triplets, and negative samples.
For the DrugBank Dataset

The script is pre-configured for the DrugBank dataset. Place the drugbank.tab file in the data/ directory.

Run the preprocessing script:

python preprocess.py -d drugbank -o all

This will create the following directory and files: data/preprocessed/drugbank/.

After running these steps, the respective preprocessed folder will contain drug_data.pkl, processed_train.csv, and processed_test.csv, among other files.
Training the Model

Training is handled by the train.py script. All hyperparameters and settings can be configured directly within the config dictionary in the main() function.

    Configure the Training Run:
    Open train.py and modify the config dictionary.
        Set dataset_name to either 'drugbank' or 'decagon'.
        Adjust preprocessed_train_file and preprocessed_test_file to match the filenames generated by the preprocessing script.
        Adjust hyperparameters like lr, batch_size, epochs, kge_dim, etc.

    # Example configuration in train.py
    config = {
        'model_types_to_train': ['enhanced_mpnp'],
        'dataset_name': 'drugbank', # or 'decagon'
        'data_root': './data/preprocessed/',
        'preprocessed_train_file': 'processed_train.csv', # Adjust if needed
        'preprocessed_test_file': 'processed_test.csv',   # Adjust if needed
        'epochs': 50,
        'batch_size': 32,
        'lr': 0.0001,
        'kge_dim': 64,
        # ... other parameters
    }

    Start Training:
    Execute the script from the command line:

    python train.py

Results and Logging

The framework provides comprehensive logging and result tracking. For each run, a new directory is created in the save/ folder with a unique timestamp, e.g., save/20250722_220000_enhanced_mpnp_drugbank/.

This directory contains:

    config.json: A copy of the configuration used for the run.
    log/: Contains the detailed training log file (.log).
    model/: Stores the best performing model checkpoint (best_model.pth).
    enhanced_mpnp_training_curves.png: A plot visualizing the training process, including losses and performance metrics (AUROC, etc.) over epochs.
    final_summary.csv: A summary of the best performance achieved during the experiment.

